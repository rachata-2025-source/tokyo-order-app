<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏ô‡∏°‡πÇ‡∏ï‡πÄ‡∏Å‡∏µ‡∏¢‡∏ß</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:sans-serif;background:#F5E3CB;margin:0;padding:12px;}
.card{background:#fff;padding:12px;border-radius:14px;margin-bottom:10px;}
button{padding:10px;border-radius:14px;border:0;font-size:16px}
.add{background:#ff9800;color:#fff}
.save{background:#4caf50;color:#fff;width:100%}
.done{background:#2196f3;color:#fff}
.export{margin-bottom:5px;background:#9c27b0;color:#fff;width:100%}
.import{margin-bottom:5px; background:#ff9800;color:#fff;width:100%}
.del{font-size:14px; background:#f44336;color:#fff}
.edit{background:#ff9800;color:#fff}
.queue{font-size:18px;font-weight:bold}
.tab{display:flex;gap:6px;margin:12px 0}
.tab button{flex:1;background:#ddd}
.tab button.active{
  background:#4caf50;
  color:#fff;
  font-weight:bold;
}
.price{font-weight:bold;margin-top:6px}
.note{font-size:16px;color:#555;margin-top:2px}

input[type="number"]{width:80px;text-align:center;}
textarea{width:90%;border-radius:10px;padding:8px;border:1px solid #ccc; font-size:18px;}

.fillings{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}
.fillings label{
  display:block;
  background:#ffe0b2;
  padding:10px;
  border-radius:12px;
  text-align:center;
  font-weight:bold;
}
.fillings input{display:none;}
.fillings input:checked + span{
  background:#ff9800;
  color:#fff;
  display:block;
  padding:10px;
  border-radius:12px;
}

/* ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• + ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
.queue{
  font-size:14px;
  font-weight:bold;
  color:#555;
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ */
.bill-summary{
  text-align:right;
  font-size:18px;
  font-weight:bold;
}
/* ‡πÑ‡∏™‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô */
.bill-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
 font-size:28px;
  font-weight:bold;
  margin:6px 0;
}

.item-name{
  font-size:28px;   /* üî• ‡πÑ‡∏™‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏£‡∏¥‡∏á */
  font-weight:bold;
}

.item-price{
  font-size:16px;   /* ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ */
}
/*‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô*/
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:12px 18px;
  border-radius:20px;
  font-size:16px;
  opacity:0;
  pointer-events:none;
  transition:.4s;
  z-index:999;
}
.toast.show{opacity:1; pointer-events:auto;}

.toast.success{background:#4caf50}
.toast.error{background:#f44336}
.toast.info{background:#2196f3}

.toast button{
  margin:0 6px;
  padding:6px 14px;
  border-radius:12px;
  border:0;
  font-size:14px;
}
.toast .ok{background:#4caf50;color:#fff}
.toast .cancel{background:#777;color:#fff}


</style>
</head>

<body>

<div class="card fillings" id="fillingsBox"></div>
<button class="add" onclick="addPiece()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ö‡∏¥‡∏•</button>

<h2>‡∏ö‡∏¥‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
<div id="currentBill"></div>

<div class="card">
  <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ö‡∏¥‡∏•</b>
  <textarea id="billNote"></textarea>
</div>

<button class="save" onclick="saveBill()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•</button>

<div class="tab">
  <button id="tabDoing" onclick="view='doing';activeBillNo=null;renderBills()">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</button>
  <button id="tabDone" onclick="view='done';activeBillNo=null;renderBills()">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
</div>

<div id="todayTotal" class="card"></div>
<div id="billList"></div>
<div id="exportBox"></div>

<script>
const KEY='tokyo_bills';
const BASE=10;
let view='doing';
let currentPieces=[];
let billCounter=parseInt(localStorage.getItem('billCounter')||'1');
let activeBillNo=null;
let editingBillNo=null;

const fillings=[
'‡∏´‡∏ß‡∏≤‡∏ô','‡πÄ‡∏Ñ‡πá‡∏°','‡∏£‡∏ß‡∏°','‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏ú‡∏≤','‡∏´‡∏°‡∏π‡∏´‡∏¢‡∏≠‡∏á','‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö','‡∏Æ‡∏≠‡∏ï‡∏î‡∏≠‡∏Å','‡∏õ‡∏π‡∏≠‡∏±‡∏î','‡∏ã‡∏≠‡∏™‡πÑ‡∏Ç‡πà‡∏Å‡∏∏‡πâ‡∏á','‡∏ã‡∏≠‡∏™‡∏ä‡∏µ‡∏™','‡πÉ‡∏ö‡πÄ‡∏ï‡∏¢','‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡∏µ‡πà','‡∏Ñ‡∏£‡∏µ‡∏°‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î','‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤',
'‡∏ô‡∏π‡πÄ‡∏ó‡∏•‡∏•‡πà‡∏≤','‡∏ù‡∏≠‡∏¢‡∏ó‡∏≠‡∏á','‡πÑ‡∏Ç‡πà'
];

function loadBills(){return JSON.parse(localStorage.getItem(KEY)||'[]');}
function saveBills(b){localStorage.setItem(KEY,JSON.stringify(b));}

fillingsBox.innerHTML=fillings.map(f=>`
<label><input type="checkbox" value="${f}"><span>${f}</span></label>
`).join('');

function calcPrice(items){
  let price = BASE; // 10

  // ‡∏Ñ‡∏π‡πà‡∏û‡∏¥‡πÄ‡∏®‡∏©
  if(items.includes('‡∏ô‡∏π‡πÄ‡∏ó‡∏•‡∏•‡πà‡∏≤') && items.includes('‡∏ù‡∏≠‡∏¢‡∏ó‡∏≠‡∏á')){
    price = 15;
  }

  // ‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
  if(items.includes('‡πÑ‡∏Ç‡πà')) price += 5;
  if(items.includes('‡∏ã‡∏≠‡∏™‡πÑ‡∏Ç‡πà‡∏Å‡∏∏‡πâ‡∏á')) price += 5;

  return price;
}

function addPiece(){
  const items=[...document.querySelectorAll('#fillingsBox input:checked')].map(i=>i.value);
  if(!items.length) return showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏™‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ üòÖ','error');
  currentPieces.push({items,price:calcPrice(items)});
  document.querySelectorAll('#fillingsBox input').forEach(c=>c.checked=false);
  renderCurrent();
}

function renderCurrent(){
  currentBill.innerHTML='';
  let total=0;
  currentPieces.forEach((p,i)=>{
    total+=p.price;
    currentBill.innerHTML+=`
      <div class="card">
        ‡∏ä‡∏¥‡πâ‡∏ô ${i+1}: ${p.items.join(' + ')}<br>
        ‡∏£‡∏≤‡∏Ñ‡∏≤ <input type="number" value="${p.price}" onchange="pUpdate(${i},this.value)"> ‡∏ö‡∏≤‡∏ó
        <button class="del" onclick="pDel(${i})">‡∏•‡∏ö</button>
      </div>`;
  });
  currentBill.innerHTML+=`<div class="price">‡∏£‡∏ß‡∏° ${total} ‡∏ö‡∏≤‡∏ó</div>`;
}

function pUpdate(i,v){currentPieces[i].price=parseInt(v)||0;renderCurrent();}
function pDel(i){currentPieces.splice(i,1);renderCurrent();}

function saveBill(){
  if(!currentPieces.length) return;
  const bills=loadBills();
const isEdit = editingBillNo !== null;


  if(editingBillNo!==null){
    const b=bills.find(x=>x.billNo===editingBillNo);
    if(!b) return;
    b.pieces=currentPieces;
    b.note=billNote.value;
    editingBillNo=null;
  }else{
    bills.push({
      billNo:billCounter,
      date:new Date().toISOString().slice(0,10),
      time:new Date().toLocaleTimeString(),
      pieces:currentPieces,
      note:billNote.value,
      status:'doing'
    });
    billCounter++;
    localStorage.setItem('billCounter',billCounter);
  }

  saveBills(bills);
  currentPieces=[];
  billNote.value='';
  renderCurrent();
showToast(
  isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úèÔ∏è' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚úîÔ∏è',
  'success'
);

  renderBills();
}

function editBill(no){
  const bills=loadBills();
  const b=bills.find(x=>x.billNo===no);
  if(!b) return;
  currentPieces=JSON.parse(JSON.stringify(b.pieces));
  billNote.value=b.note||'';
  editingBillNo=no;
  view='doing';
  activeBillNo=null;
  renderCurrent();
  renderBills();
  showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏• #${no}`);
}

function finishBill(no){
  const bills=loadBills();
  const b=bills.find(x=>x.billNo===no);
  if(!b) return;

  b.status='done';
  saveBills(bills);

  activeBillNo=null;
  renderBills();

  showToast(`‡∏ö‡∏¥‡∏• #${no} ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ`,'success');
}


function selectBill(no){
  activeBillNo = activeBillNo===no ? null : no;
  renderBills();
}

function deleteBill(no){
  showConfirm(
    `‡∏•‡∏ö‡∏ö‡∏¥‡∏• #${no} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? üóëÔ∏è`,
    () => {
      saveBills(loadBills().filter(b=>b.billNo!==no));
      activeBillNo=null;
      renderBills();
      showToast('‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß','success');
    }
  );
}

function confirmToast(msg,yes){
  const t=document.getElementById('toast');
  t.className='toast show info';
  t.innerHTML=`
  <div style="margin-bottom:10px">${msg}</div>
  <button class="ok" onclick="yes();hideToast()">‡∏ï‡∏Å‡∏•‡∏á</button>
  <button class="cancel" onclick="hideToast()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
`;
}

function hideToast(){
  document.getElementById('toast').className='toast';
}


function renderTodayTotal(){
  const today=new Date().toISOString().slice(0,10);
  const bills=loadBills().filter(b=>b.status==='done'&&b.date===today);
  const sum=bills.reduce((s,b)=>s+b.pieces.reduce((a,p)=>a+p.price,0),0);
  todayTotal.innerHTML=`<b>‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</b> ${sum} ‡∏ö‡∏≤‡∏ó<br><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•:</b> ${bills.length} ‡∏ö‡∏¥‡∏•`;
}

function renderBills(){
  tabDoing.classList.toggle('active',view==='doing');
  tabDone.classList.toggle('active',view==='done');

  billList.innerHTML='';
  exportBox.innerHTML='';

  loadBills().filter(b=>b.status===view).forEach(b=>{
    const sum=b.pieces.reduce((s,p)=>s+p.price,0);
    const active=activeBillNo===b.billNo;
    billList.innerHTML+=`
      <div class="card" onclick="selectBill(${b.billNo})">
        <div class="queue">‡∏ö‡∏¥‡∏• #${b.billNo} (${b.time})</div>
        <div class="bill-items">
  ${b.pieces.map(p=>`
    <div class="bill-item">
      <span class="item-name">${p.items.join(' + ')}</span>
      <span class="item-price">${p.price}‡∏ø</span>
    </div>
  `).join('')}
</div>
        ${b.note?`<div class="note">üìù ${b.note}</div>`:''}
        <div class="price">‡∏£‡∏ß‡∏° ${sum} ‡∏ö‡∏≤‡∏ó</div>
        ${active?`
        <div style="display:flex;gap:6px;margin-top:8px">
          <button class="edit" onclick="editBill(${b.billNo});event.stopPropagation()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="del" onclick="deleteBill(${b.billNo});event.stopPropagation()">üóëÔ∏è ‡∏•‡∏ö</button>
          ${b.status==='doing'?`<button class="done" onclick="finishBill(${b.billNo});event.stopPropagation()">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>`:''}
        </div>`:''}
      </div>`;
  });

  if(view==='done'){
  exportBox.innerHTML=`
<input type="file" id="importExcel" accept=".xlsx" style="display:none" onchange="importExcel(this)">
<button class="import" onclick="document.getElementById('importExcel').click()">
  üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
</button>
    <button class="export" onclick="exportExcel()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
    <button class="del" style="width:100%;margin-top:10px" onclick="clearDoneBills()">
      üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    </button>
  `;
  renderTodayTotal();
}else{
  todayTotal.innerHTML='';
}
}

function importExcel(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e=>{
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{header:1});

    rows.shift(); // ‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á

    let bills = {};
    rows.forEach(r=>{
      const [date,billNo,items,price,note] = r;
      if(!billNo) return;

      if(!bills[billNo]){
        bills[billNo]={
          billNo:Number(billNo),
          date,
          time:'',
          status:'done',
          note:note||'',
          pieces:[]
        };
      }

      bills[billNo].pieces.push({
        items: String(items).split('+'),
        price: Number(price)
      });
    });

    // ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö)
    const old = loadBills();
    const merged = [...old.filter(b=>!bills[b.billNo]), ...Object.values(bills)];

    saveBills(merged);
    renderBills();
    showToast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üì•','success');
  };
  reader.readAsArrayBuffer(file);
}

function exportExcel(){
  const bills=loadBills().filter(b=>b.status==='done');
  const rows=[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•','‡πÑ‡∏™‡πâ','‡∏£‡∏≤‡∏Ñ‡∏≤','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']];
  bills.forEach(b=>{
    b.pieces.forEach(p=>{
      rows.push([b.date,b.billNo,p.items.join('+'),p.price,b.note||'']);
    });
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'orders');
  XLSX.writeFile(wb,'tokyo_orders.xlsx');
}

function clearDoneBills(){
  if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö')) return;

  exportExcel();

  let bills = loadBills().filter(b=>b.status!=='done');

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏¢ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß
  if(bills.length===0){
    billCounter=1;
    localStorage.setItem('billCounter','1');
  }

  saveBills(bills);
  showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üßπ','success');
  renderBills();
}

renderBills();

function showToast(msg,type='info'){
  const t=document.getElementById('toast');
  t.className='toast show '+type;
  t.innerText=msg;
  setTimeout(()=>t.className='toast',2000);
}
function showConfirm(msg, onOk){
  const t=document.getElementById('toast');
  t.className='toast show';
  t.innerHTML=`
    <div>${msg}</div>
    <div class="toast-actions">
      <button onclick="confirmOk()">‡∏ï‡∏Å‡∏•‡∏á</button>
      <button onclick="hideToast()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  `;
  window._confirmOk = onOk;
}

function confirmOk(){
  if(window._confirmOk) window._confirmOk();
  hideToast();
}

function hideToast(){
  const t=document.getElementById('toast');
  t.className='toast';
  t.innerHTML='';
}


</script>
<div id="toast" class="toast"></div>
</body>
</html>
