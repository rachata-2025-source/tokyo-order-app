<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Tokyo Order Pro - Modern System V2.2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #FF9800; --primary-dark: #F57C00; --secondary: #2196F3;
            --success: #4CAF50; --danger: #F44336; --bg: #F8F9FA;
            --card-shadow: 0 8px 30px rgba(0,0,0,0.05); --border-radius: 16px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); margin: 0; padding: 15px; color: #333; }
        .container { max-width: 98%; margin: 0 auto; }
        .card { background: #fff; border-radius: var(--border-radius); padding: 16px; margin-bottom: 12px; box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.02); }
        .section-title { font-size: 0.85rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; font-weight: 600; }
        
        /* Fillings Grid */
        /* ‡∏õ‡∏£‡∏±‡∏ö Grid ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏õ‡∏à‡∏ô‡πÄ‡∏ö‡∏µ‡∏¢‡∏î‡∏Å‡∏±‡∏ô) */
.fillings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏à‡∏≤‡∏Å 80 ‡πÄ‡∏õ‡πá‡∏ô 95 */
    gap: 6px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° */
    margin-bottom: 15px;
}
        .fillings-grid input { display: none; }
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏™‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
.fillings-grid span {
    display: block;
    background: #f0f0f0;
    padding: 10px 4px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Padding ‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á ‡∏à‡∏≤‡∏Å 10 ‡πÄ‡∏õ‡πá‡∏ô 15 */
    border-radius: 12px;
    text-align: center;
    font-size: 1rem; 
    font-weight: 500; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
    transition: 0.2s;
    border: 2px solid transparent;
}
        .fillings-grid input:checked + span { background: #FFF3E0; border-color: var(--primary); color: var(--primary-dark); font-weight: 500; }

        /* Custom Input Section */
        #customInputArea { display: none; margin-bottom: 12px; background: #FFF3E0; padding: 12px; border-radius: 12px; border: 1px dashed var(--primary); }
        .custom-fill-group { display: flex; gap: 4px; }
        .custom-fill-group input { border: 1px solid #ddd; background: #fff; padding: 8px; border-radius: 8px; font-family: 'Kanit'; outline: none; font-size: 0.9rem; min-width: 0;}
        .btn-toggle-custom { background: #f1f3f5; color: #666; width: 100%; margin-bottom: 12px; font-size: 0.9rem; border: 1px solid #eee; border-radius: 10px; padding: 10px; cursor: pointer; }

        /* Current Bill UI */
        .current-item { border-bottom: 1px solid #f8f8f8; padding: 8px 0; }
        .item-row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .price-input-group { display: flex; align-items: center; gap: 3px; background: #f1f3f5; padding: 2px 8px; border-radius: 8px; }
        .price-input-group input { border: none; background: transparent; width: 40px; font-family: 'Kanit'; text-align: center; font-weight: 600; outline: none; }

        /* Buttons & Tabs */
        .btn { border: none; border-radius: 12px; padding: 12px; font-family: 'Kanit'; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-add { background: var(--primary); color: white; height: 45px; }
        .btn-save { background: var(--success); color: white; width: 100%; font-size: 1.1rem; margin-top: 10px; }
        .btn-outline { background: #fff; border: 1.5px solid #eee; color: #666; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; border-radius: 8px; }
        
        .tabs { display: flex; gap: 6px; margin: 15px 0; background: #eee; padding: 4px; border-radius: 14px; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; font-size: 0.85rem; color: #777; }
        .tab.active { background: #fff; color: var(--secondary); font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .bill-header { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; z-index: 2000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; pointer-events: auto; }
        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
.btn-finish-large {
    flex: 3 !important; /* ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏•‡∏ö */
    font-size: 1rem !important; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
    padding: 10px !important; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° */
    background-color: var(--success) !important;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡πà‡∏≤‡∏Å‡∏î */
}
/* ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î */
.dark-toggle {
    position: fixed;
    top: 12px;
    right: 12px;
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: none;
    background: #333;
    color: #fff;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    z-index: 3000;
}
/* ===== DARK MODE ===== */
body.dark {
    --bg: #121212;
    --primary: #FFB74D;
    --primary-dark: #FFA726;
    --secondary: #64B5F6;
    --success: #66BB6A;
    --danger: #EF5350;
}
body.dark {
    background-color: var(--bg);
    color: #eee;
}
body.dark .card {
    background: #1E1E1E;
    border: 1px solid rgba(255,255,255,0.05);
}
body.dark .section-title {
    color: #aaa;
}
body.dark .fillings-grid span {
    background: #2A2A2A;
    color: #ddd;
}
body.dark .fillings-grid input:checked + span {
    background: #3A2A1A;
}
body.dark .tabs {
    background: #2A2A2A;
}
body.dark .tab.active {
    background: #1E1E1E;
}
body.dark .btn-outline {
    background: #1E1E1E;
    color: #ddd;
    border-color: #333;
}

body.dark .price-input-group{
    background: #2A2A2A;

}
body.dark .price-input-group input {
    color: #fff;
}

body.dark .toast {
    background: #000;
}

    </style>
</head>
<body>

<div class="container">
<button id="darkToggle" class="dark-toggle">üåô</button>

    <div class="card" style="padding-bottom:12px;">
        <span class="section-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏™‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</span>
        <div class="fillings-grid" id="fillingsBox"></div>
        
        <button class="btn-toggle-custom" id="btnShowCustom" onclick="toggleCustomArea(true)">‚ûï ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏™‡πâ‡πÄ‡∏≠‡∏á</button>
        
        <div id="customInputArea">
            <span class="section-title" style="color:var(--primary-dark)">‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏™‡πâ‡πÉ‡∏´‡∏°‡πà</span>
            <div class="custom-fill-group">
                <input type="text" id="customName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏™‡πâ..." style="flex:2">
                <input type="number" id="customPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" style="flex:1">
            </div>
            <div style="display:flex; gap:6px; margin-top:8px;">
                <button class="btn btn-outline btn-sm" style="flex:1" onclick="toggleCustomArea(false)">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-add btn-sm" style="flex:2" onclick="addCustomPiece()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏™‡πâ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ö‡∏¥‡∏•</button>
            </div>
        </div>

        <div style="display: flex; gap: 8px; align-items: center;">
            <div style="flex: 1; background: #F1F3F5; padding: 5px; border-radius: 12px; display:flex; justify-content:space-around; align-items:center;">
                <button class="btn btn-outline btn-sm" style="border-radius:50%; width:30px; height:30px; padding:0" onclick="changeQty(-1)">‚àí</button>
                <input type="number" id="pieceQty" value="1" readonly style="border:none; background:transparent; width:35px; text-align:center; font-weight:600;">
                <button class="btn btn-outline btn-sm" style="border-radius:50%; width:30px; height:30px; padding:0" onclick="changeQty(1)">Ôºã</button>
            </div>
            <button class="btn btn-add" style="flex: 2;" onclick="addPiece()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ö‡∏¥‡∏•</button>
        </div>
    </div>

    <div id="editHint" style="text-align:center; font-weight:bold; color:var(--danger); font-size:0.9rem;"></div>
    <div class="card" id="currentBillContainer" style="padding: 12px;">
        <span class="section-title" style="margin-bottom:5px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ö‡∏¥‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
        <div id="currentBill"></div>
        
        <div style="margin-top:10px;">
            <textarea id="billNote" style="width:100%; height:35px; border:1px solid #eee; border-radius:10px; padding:8px; font-family:'Kanit'; outline:none; font-size:0.9rem;" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏ö‡∏¥‡∏•..."></textarea>
        </div>
        <button id="mainSaveBtn" class="btn btn-save" onclick="saveBill()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏• (0.-)</button>
    </div>

    <div class="tabs">
        <div id="tabDoing" class="tab active" onclick="view='doing';activeBillNo=null;renderBills()">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ üî•</div>
        <div id="tabDone" class="tab" onclick="view='done';activeBillNo=null;renderBills()">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</div>
        <div id="tabSummary" class="tab" onclick="view='summary';activeBillNo=null;renderBills()">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î üìä</div>
    </div>

    <div id="todayTotal"></div>
    <div id="billList"></div>
    <div id="summaryBox"></div>
    <div id="exportBox"></div>
</div>

<div id="toast" class="toast"></div>

<script>
const KEY='tokyo_bills';
const BASE=10;
let view='doing';
let currentPieces=[];
let billCounter=parseInt(localStorage.getItem('billCounter')||'1');
let activeBillNo=null;
let editingBillNo=null;

const fillings=['‡∏´‡∏ß‡∏≤‡∏ô','‡πÄ‡∏Ñ‡πá‡∏°','‡∏£‡∏ß‡∏°','‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏ú‡∏≤','‡∏´‡∏°‡∏π‡∏´‡∏¢‡∏≠‡∏á','‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö','‡∏Æ‡∏≠‡∏ï‡∏î‡∏≠‡∏Å','‡∏õ‡∏π‡∏≠‡∏±‡∏î','‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤','‡∏ã‡∏≠‡∏™‡πÑ‡∏Ç‡πà‡∏Å‡∏∏‡πâ‡∏á','‡∏ã‡∏≠‡∏™‡∏ä‡∏µ‡∏™','‡πÉ‡∏ö‡πÄ‡∏ï‡∏¢','‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡∏µ‡πà','‡∏Ñ‡∏£‡∏µ‡∏°‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î','‡∏ô‡∏π‡πÄ‡∏ó‡∏•‡∏•‡πà‡∏≤','‡∏ù‡∏≠‡∏¢‡∏ó‡∏≠‡∏á','‡πÑ‡∏Ç‡πà'];

const fillingsBox = document.getElementById('fillingsBox');
fillingsBox.innerHTML=fillings.map(f=>`<label><input type="checkbox" value="${f}"><span>${f}</span></label>`).join('');

function toggleCustomArea(show) {
    document.getElementById('customInputArea').style.display = show ? 'block' : 'none';
    document.getElementById('btnShowCustom').style.display = show ? 'none' : 'block';
    if(!show) {
        document.getElementById('customName').value = '';
        document.getElementById('customPrice').value = '';
    }
}

function calcPrice(items){
    let price = BASE;
    if(items.includes('‡∏ô‡∏π‡πÄ‡∏ó‡∏•‡∏•‡πà‡∏≤') && items.includes('‡∏ù‡∏≠‡∏¢‡∏ó‡∏≠‡∏á')) price = 15;
    if(items.includes('‡πÑ‡∏Ç‡πà')) price += 5;
    if(items.includes('‡∏ã‡∏≠‡∏™‡πÑ‡∏Ç‡πà‡∏Å‡∏∏‡πâ‡∏á')) price += 5;
    return price;
}

function addPiece() {
    const items=[...document.querySelectorAll('#fillingsBox input:checked')].map(i=>i.value);
    const qty = parseInt(document.getElementById('pieceQty').value) || 1;
    if(!items.length) return showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏™‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞','error');
    const price = calcPrice(items);
    const found = currentPieces.find(p => JSON.stringify(p.items) === JSON.stringify(items));
    if(found) found.qty += qty;
    else currentPieces.push({ items, price, qty });
    resetInputs();
}

function addCustomPiece() {
    const name = document.getElementById('customName').value.trim();
    const price = parseInt(document.getElementById('customPrice').value);
    const qty = parseInt(document.getElementById('pieceQty').value) || 1;
    if(!name || isNaN(price)) return showToast('‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error');
    currentPieces.push({ items: [name], price, qty });
    toggleCustomArea(false);
    resetInputs();
}

function resetInputs() {
    document.getElementById('pieceQty').value = 1;
    document.querySelectorAll('#fillingsBox input').forEach(c=>c.checked=false);
    renderCurrent();
}

function changeQty(step){
    const input = document.getElementById('pieceQty');
    let v = parseInt(input.value) || 1;
    v = Math.max(1, v + step);
    input.value = v;
}

function renderCurrent(){
    const currentBillDiv = document.getElementById('currentBill');
    currentBillDiv.innerHTML='';
    let total=0;
    let totalQty = 0;
    if(currentPieces.length === 0) {
        currentBillDiv.innerHTML = '<div style="text-align:center; color:#ccc; padding:5px; font-size:0.8rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ö‡∏¥‡∏•</div>';
    }
    currentPieces.forEach((p,i)=>{
        const lineTotal = p.price * p.qty;
        total += lineTotal;
totalQty += p.qty || 1;
        currentBillDiv.innerHTML+=`
            <div class="current-item">
                <div class="item-row-top">
                    <b style="font-size:1rem;">${p.items.join('+')}</b>
                    <button class="btn btn-outline btn-sm" style="color:red; border:none;" onclick="pDel(${i})">‡∏•‡∏ö</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="btn btn-outline btn-sm" style="width:25px; height:25px; padding:0" onclick="pQty(${i},-1)">-</button>
                        <b>${p.qty}</b>
                        <button class="btn btn-outline btn-sm" style="width:25px; height:25px; padding:0" onclick="pQty(${i},1)">+</button>
                    </div>
                    <div class="price-input-group">
                        <small>‡∏ø</small><input type="number" value="${p.price}" onchange="pUpdate(${i},this.value)">
                    </div>
                </div>
            </div>`;
    });
currentBillDiv.innerHTML += `
    <div style="text-align:center; font-size:1rem; color:#666; margin-top:6px;">
        ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalQty} ‡∏ä‡∏¥‡πâ‡∏ô
    </div>
`;
    document.getElementById('mainSaveBtn').innerText = `üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏• (${total}.-)`;
}

function pUpdate(i,v){currentPieces[i].price=parseInt(v)||0;renderCurrent();}
function pDel(i){currentPieces.splice(i,1);renderCurrent();}
function pQty(i,d){currentPieces[i].qty = Math.max(1, (currentPieces[i].qty||1)+d); renderCurrent();}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•
function saveBill(){
    if(currentPieces.length === 0) return showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏∞','error');
    
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]');
    const noteEl = document.getElementById('billNote');
    
    if(editingBillNo !== null){
        const b = bills.find(x => x.billNo === editingBillNo);
        if(b){ 
            b.pieces = JSON.parse(JSON.stringify(currentPieces)); 
            b.note = noteEl.value; 
        }
        editingBillNo = null;
    } else {
        bills.push({
            billNo: billCounter++, 
            date: new Date().toISOString().slice(0,10),
            time: new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}),
            pieces: JSON.parse(JSON.stringify(currentPieces)), 
            note: noteEl.value, 
            status: 'doing',
    paid: false   // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        });
        localStorage.setItem('billCounter', billCounter);
    }
    
    localStorage.setItem(KEY, JSON.stringify(bills));
    currentPieces = []; 
    noteEl.value = ''; 
    renderCurrent(); 
    renderBills(); 
    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','success');
}

function renderBills(){
    const editHint = document.getElementById('editHint');
    const billList = document.getElementById('billList');
    const summaryBox = document.getElementById('summaryBox');
    const exportBox = document.getElementById('exportBox');
    const todayTotal = document.getElementById('todayTotal');

    editHint.innerText = editingBillNo !== null ? `‚úèÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏• #${editingBillNo}` : '';
    document.getElementById('tabDoing').classList.toggle('active',view==='doing');
    document.getElementById('tabDone').classList.toggle('active',view==='done');
    document.getElementById('tabSummary').classList.toggle('active', view==='summary');

    summaryBox.innerHTML = ''; billList.innerHTML=''; exportBox.innerHTML=''; todayTotal.innerHTML='';
    if(view === 'summary'){ renderSummary(); return; }

    const bills = JSON.parse(localStorage.getItem(KEY) || '[]').filter(b=>b.status===view);
    if(view === 'done') renderTodayTotal();

    bills.sort((a,b) => view==='doing' ? a.billNo - b.billNo : b.billNo - a.billNo).forEach(b=>{
        const sum = b.pieces.reduce((s,p)=> s + (parseInt(p.price)*(p.qty||1)), 0);
        const active = activeBillNo === b.billNo;
const qtySum = b.pieces.reduce((s,p)=> s + (p.qty||1), 0);
        billList.innerHTML+=`
            <div class="card" onclick="selectBill(${b.billNo})" style="border-left:5px solid ${view==='doing'?'var(--primary)':'var(--success)'}">
                <div class="bill-header">
                    <span style="font-size:0.9rem; color:#888;">#${b.billNo} ‚Ä¢ ${b.time}  ‚Ä¢ ${qtySum} ‡∏ä‡∏¥‡πâ‡∏ô</span>
${(view==='doing' && b.paid) ?  '  üí∞ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : ''}
                    <b style="color:var(--primary); font-size:1.3rem;">${sum}.-</b>
                </div>
                <div style="font-size:1.8rem; line-height:1.7;">
                    ${b.pieces.map(p=>`<div>${p.items.join('+')} x${p.qty||1} <span style="float:right; color:#888; font-size:1.4rem;">${parseInt(p.price)*(p.qty||1)}‡∏ø</span></div>`).join('')}
                </div>
                ${b.note?`<div style="margin-top:8px; padding:5px; background:#fff9c4; border-radius:5px; font-size:1.2rem;">üìù ${b.note}</div>`:''}
                ${active?`
<div style="display:flex; gap:8px; margin-top:12px; border-top:1px solid #eee; padding-top:10px;">
    
    <button class="btn btn-outline btn-sm" style="flex:1"
        onclick="editBill(${b.billNo});event.stopPropagation()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

    <button class="btn btn-danger btn-sm" style="flex:1; background:#fff5f5; color:red; border:none;"
        onclick="deleteBill(${b.billNo});event.stopPropagation()">üóëÔ∏è ‡∏•‡∏ö</button>

    ${b.status==='doing'?`
        ${(view==='doing' && b.status==='doing') ? `
    <button class="btn btn-sm"
        style="flex:1; background:${b.paid?'#d4edda':'#fff3cd'};"
        onclick="togglePaid(${b.billNo});event.stopPropagation()">
        ${b.paid?'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢':'‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'}
    </button>
` : ''}


        <button class="btn btn-finish-large" style="flex:3"
            onclick="finishBill(${b.billNo});event.stopPropagation()">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
    `:''}

</div>`:''}
            </div>`;
    });

    if(view==='done'){
        exportBox.innerHTML=`
            <div class="card" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <input type="file" id="importExcel" accept=".xlsx" style="display:none" onchange="importExcel(this)">
                <button class="btn btn-outline btn-sm" onclick="document.getElementById('importExcel').click()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel</button>
                <button class="btn btn-outline btn-sm" onclick="exportExcel()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                <button class="btn btn-outline btn-sm" style="grid-column: span 2; color:red;" onclick="clearDoneBills()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                <button class="btn btn-sm" style="grid-column: span 2; background:#333; color:white; margin-top:10px;" onclick="closeShop()">üîí ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö)</button>
            </div>`;
    }
}

function renderTodayTotal(){
    const today = new Date().toISOString().slice(0,10);
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]').filter(b => b.status === 'done' && b.date === today);
    let totalMoney = 0;
    bills.forEach(b=> b.pieces.forEach(p=> totalMoney += parseInt(p.price) * (p.qty || 1)));
    document.getElementById('todayTotal').innerHTML = `
        <div style="display:flex; gap:0px; margin-bottom:0px;">
            <div class="card" style="flex:1; margin-bottom:0; text-align:center;"><small class="section-title">‡∏ö‡∏¥‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small><b>${bills.length}</b></div>
            <div class="card" style="flex:1; margin-bottom:0; text-align:center;"><small class="section-title">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</small><b style="color:var(--success)">${totalMoney}.-</b></div>
        </div>`;
}

function renderSummary(){
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]').filter(b=>b.status==='done');
    const summaryBox = document.getElementById('summaryBox');
    if(!bills.length){ summaryBox.innerHTML = '<div class="card" style="text-align:center; padding:30px; color:#ccc;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }
    
    let totalMoney = 0, totalBills = bills.length, totalPieces = 0, itemMap = {};
    bills.forEach(b=>{
        b.pieces.forEach(p=>{
            const qty = parseInt(p.qty) || 1, key = p.items.join('+'), price = parseInt(p.price);
            totalMoney += price * qty; totalPieces += qty;
            if(!itemMap[key]) itemMap[key] = { qty:0, money:0 };
            itemMap[key].qty += qty; itemMap[key].money += price * qty;
        });
    });

    const sortedItems = Object.entries(itemMap).sort((a,b)=> {
        if(b[1].qty !== a[1].qty) return b[1].qty - a[1].qty;
        return b[1].money - a[1].money;
    });

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ html ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderSummary() ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ:

let html = `<div class="card" id="summaryPrint" style="padding:20px;">
    <h3 style="text-align:center; margin:0;">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
    <p style="text-align:center; color:#888; font-size:0.8rem; margin-bottom:15px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH')}</p>
    
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div class="card" style="flex:1; margin-bottom:0; text-align:center; padding:10px; background:#f8f9fa; border:1px solid #eee;">
            <small class="section-title" style="font-size:0.7rem;">‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
            <b class="stat-val" style="display:block; font-size:1.2rem; color:var(--secondary);">${totalBills}</b>
        </div>
        <div class="card" style="flex:1; margin-bottom:0; text-align:center; padding:10px; background:#f8f9fa; border:1px solid #eee;">
            <small class="section-title" style="font-size:0.7rem;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô</small>
            <b class="stat-val" style="display:block; font-size:1.2rem; color:var(--primary);">${totalPieces}</b>
        </div>
        <div class="card" style="flex:1; margin-bottom:0; text-align:center; padding:10px; background:#f8f9fa; border:1px solid #eee;">
            <small class="section-title" style="font-size:0.7rem;">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</small>
            <b class="stat-val" style="display:block; font-size:1.2rem; color:var(--success);">${totalMoney}</b>
        </div>
    </div>

    <span class="section-title">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏™‡πâ‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</span>`;
    
    sortedItems.forEach(([name,v],i)=>{
        const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
        html += `<div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f9f9f9; font-size:0.95rem;">
            <span>${name} ${medal}</span><span>${v.qty} ‡∏ä‡∏¥‡πâ‡∏ô | ${v.money}‡∏ø</span>
        </div>`;
    });
    html += `</div><div style="display:flex; gap:8px;">
        <button class="btn btn-outline btn-sm" style="flex:1" onclick="exportSummaryExcel()">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏ÅExcel</button>
        <button class="btn btn-outline btn-sm" style="flex:1" onclick="exportSummaryImage()">üñºÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
    </div>`;
    summaryBox.innerHTML = html;
}

function importExcel(input){
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data,{type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws,{header:1}); rows.shift();
        let billsMap = {};
        rows.forEach(r=>{
            const [date,billNo,items,qty,price,total,note] = r; if(!billNo) return;
            if(!billsMap[billNo]) billsMap[billNo]={ billNo:Number(billNo), date, time: new Date().toLocaleTimeString('th-TH'), status:'done', note:note||'', pieces:[] };
            billsMap[billNo].pieces.push({ items: String(items).split('+'), qty: Number(qty)||1, price: Number(price)||0 });
        });
        const currentBills = JSON.parse(localStorage.getItem(KEY) || '[]');
        const merged = [...currentBills.filter(b=>!billsMap[b.billNo]), ...Object.values(billsMap)];
        localStorage.setItem(KEY, JSON.stringify(merged));
        syncBillCounter(); renderBills(); showToast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
    };
    reader.readAsArrayBuffer(file);
}

function syncBillCounter(){ 
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]'); 
    const maxNo = bills.reduce((m,b)=>Math.max(m,parseInt(b.billNo)||0),0); 
    billCounter = maxNo + 1; 
    localStorage.setItem('billCounter', billCounter); 
}

function exportExcel(){
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]').filter(b=>b.status==='done');
    const rows=[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•','‡πÑ‡∏™‡πâ','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô','‡∏£‡∏ß‡∏°','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']];
    bills.forEach(b=> b.pieces.forEach(p=> rows.push([b.date, b.billNo, p.items.join('+'), p.qty, p.price, p.price*p.qty, b.note||''])));
    const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'orders'); XLSX.writeFile(wb,`tokyo_orders.xlsx`);
}

function exportSummaryExcel(){ 
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]').filter(b=>b.status==='done');
    if(!bills.length) return; 
    let map = {}; 
    bills.forEach(b=> b.pieces.forEach(p=>{ 
        const k = p.items.join('+'); 
        if(!map[k]) map[k]={q:0,m:0}; 
        map[k].q+=p.qty; map[k].m+=(p.price*p.qty); 
    })); 
    const rows = [['‡πÑ‡∏™‡πâ','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']]; 
    Object.entries(map).sort((a,b)=>b[1].q-a[1].q).forEach(([k,v])=> rows.push([k,v.q,v.m])); 
    const ws = XLSX.utils.aoa_to_sheet(rows); 
    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb,ws,'summary'); 
    XLSX.writeFile(wb,'summary.xlsx'); 
}

function exportSummaryImage(){ 
    const box = document.getElementById('summaryPrint'); 
    html2canvas(box,{scale:2}).then(canvas=>{ 
        const link = document.createElement('a'); 
        link.download = `summary-${new Date().toISOString().slice(0,10)}.png`; 
        link.href = canvas.toDataURL(); 
        link.click(); 
    }); 
}

function editBill(no){ 
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]'); 
    const b = bills.find(x=>x.billNo===no); 
    if(!b) return; 
    currentPieces = JSON.parse(JSON.stringify(b.pieces)); 
    document.getElementById('billNote').value = b.note || ''; 
    editingBillNo = no; 
    view = 'doing'; 
    renderCurrent(); 
    renderBills(); 
    window.scrollTo(0,0); 
}

function finishBill(no){ 
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]'); 
    const b = bills.find(x=>x.billNo===no); 
    if(!b) return; 
    b.status='done'; 
    localStorage.setItem(KEY, JSON.stringify(bills));
    renderBills(); 
    showToast('‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','success'); 
}

function selectBill(no){ activeBillNo = activeBillNo===no ? null : no; renderBills(); }
function deleteBill(no){ 
    if(confirm(`‡∏•‡∏ö‡∏ö‡∏¥‡∏• #${no}?`)){ 
        const bills = JSON.parse(localStorage.getItem(KEY) || '[]');
        const filtered = bills.filter(b=>b.billNo!==no);
        localStorage.setItem(KEY, JSON.stringify(filtered));
        activeBillNo=null; 
        renderBills(); 
    } 
}
function clearDoneBills(){ 
    if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ 
        const bills = JSON.parse(localStorage.getItem(KEY) || '[]');
        const filtered = bills.filter(b=>b.status!=='done');
        localStorage.setItem(KEY, JSON.stringify(filtered));
        syncBillCounter(); 
        renderBills(); 
    } 
}

function showToast(msg,type){ 
    const t=document.getElementById('toast'); 
    t.className='toast show '+type; 
    t.innerText=msg; 
    setTimeout(()=>t.className='toast',2000); 
}

function closeShop(){ 
    if(prompt('‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô?')==='2501'){ 
        exportExcel(); 
        localStorage.removeItem(KEY); 
        localStorage.setItem('billCounter','1'); 
        location.reload(); 
    } 
}
function togglePaid(no){
    const bills = JSON.parse(localStorage.getItem(KEY) || '[]');
    const b = bills.find(x => x.billNo === no);
    if(!b) return;

    b.paid = !b.paid;
    localStorage.setItem(KEY, JSON.stringify(bills));
    renderBills();
}
const toggleBtn = document.getElementById('darkToggle');

toggleBtn.onclick = () => {
    document.body.classList.toggle('dark');

    toggleBtn.textContent =
        document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
};

// Initial Render
renderBills(); 
renderCurrent();
</script>
</body>
</html>
